<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FinTracker</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet">
  <link rel="stylesheet" href="./category.css">
   <link href="./assets/images/fin-app-logo.jpg" rel="icon" type="image/png" />
    <link rel="stylesheet" href="../style.css" />
    <script src="../script.js" defer></script>
<style>
  :root{
    --bg:#f4f7ff; --card:#ffffff; --muted:#6b7280; --accent:#2563eb; --danger:#ef4444;
    --success:#10b981; --shadow: 0 6px 18px rgba(16,24,40,0.06);
  }
  [data-theme="dark"]{
    --bg:#0b1220; --card:#071023; --muted:#94a3b8; --accent:#60a5fa; --danger:#fb7185;
    --success:#34d399; --shadow: none;
  }

  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg); color:var(--muted); -webkit-font-smoothing:antialiased;
  }

  .app {
    max-width:1100px; margin:18px auto; padding:20px; 
  }

  header{
    display:flex; gap:12px; align-items:center; justify-content:space-between;
  }
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;box-shadow:var(--shadow)}
  h1{margin:0;font-size:18px;color:var(--accent)}
  .controls {display:flex; gap:10px; align-items:center;}
  .toggle-btn {background:transparent;border:1px solid rgba(0,0,0,0.06); padding:8px;border-radius:8px;cursor:pointer}
  .toggle-btn[data-active="true"]{background:var(--card); box-shadow:var(--shadow)}

  main {margin-top:18px; display:grid; grid-template-columns: 1fr; gap:18px;}
  @media(min-width:920px){ main{grid-template-columns: 360px 1fr} }

  /* Form card */
  .card {
    background:var(--card); border-radius:14px; padding:14px; box-shadow:var(--shadow);
  }
  label {font-weight:600; display:block; color:var(--muted); margin-top:12px}
  .input, select {width:100%; padding:10px; border-radius:8px; border:1px solid #e6e9f0; background:transparent; color:inherit}
  .row {display:flex; gap:8px; align-items:center}
  .small {width:48%}
  .btn {display:inline-block;padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:white;font-weight:600;cursor:pointer;margin-top:12px; background-color: rgba(11, 156, 49, 0.8);}
  .btn.secondary {background:transparent; color:var(--muted)}
  .btn.danger{background:var(--danger)}
  .preview{
    display:flex; gap:12px; align-items:center; padding:10px; border-radius:10px; margin-top:10px; border:1px dashed #e6e9f0;
    transition:transform .18s ease, box-shadow .18s ease;
  }
  .preview .icon {font-size:26px; width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center; color:white; font-weight:700}
  .preview .meta {font-weight:700;color:var(--muted); font-size:16px}

  /* toolbar */
  .toolbar {display:flex; gap:8px; align-items:center; margin-bottom:10px; flex-wrap:wrap}
  .search {flex:1; min-width:180px}
  .select-inline {width:190px}

  /* lists */
  .list-area {display:flex; flex-direction:column; gap:12px}
  .list-header {display:flex; justify-content:space-between; align-items:center;}
  .list {display:flex; flex-direction:column; gap:8px}
  .category {
    display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px;border-radius:12px;
    transition: transform .12s ease, box-shadow .12s ease; background:linear-gradient(0deg, rgba(0,0,0,0.01), rgba(0,0,0,0.00));
  }
  .category:hover{transform:translateY(-4px); box-shadow:var(--shadow)}
  .left {display:flex; gap:12px; align-items:center; min-width:180px}
  .cat-icon {width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;flex-shrink:0}
  .cat-meta {display:flex; flex-direction:column}
  .cat-title {font-weight:700; color: #111827}
  .cat-sub {font-size:13px; color:var(--muted)}
  .cat-actions {display:flex; gap:10px; align-items:center}
  .icon-btn {border:none;background:transparent; cursor:pointer; font-size:18px; padding:8px; border-radius:8px}
  .icon-btn:hover{background:rgba(0,0,0,0.03)}
  .checkbox{width:18px;height:18px}

  /* merge bar */
  .merge-bar {display:flex; gap:8px; align-items:center; padding:10px; border-radius:10px; background:rgba(37,99,235,0.06)}
  .muted{color:var(--muted)}

  /* modal */
  .modal-back {position:fixed; inset:0; background:rgba(2,6,23,0.45); display:none; align-items:center; justify-content:center; z-index:40}
  .modal {background:var(--card); padding:16px; border-radius:12px; max-width:720px; width:92%}
  .icon-grid {display:grid; grid-template-columns: repeat(6,1fr); gap:8px; max-height:340px; overflow:auto; padding:8px}
  .icon-tile {display:flex;align-items:center;justify-content:center;padding:10px;border-radius:8px;cursor:pointer;border:1px solid transparent}
  .icon-tile:hover{border-color:rgba(0,0,0,0.06); transform:translateY(-4px);}

  /* tiny */
  .muted-small {font-size:13px;color:var(--muted)}
  .count-badge {font-size:12px;padding:6px 8px;border-radius:999px;border:1px solid rgba(0,0,0,0.06); background:transparent}

  /* animations */
  .fade-in {animation:fadeIn .18s ease}
  @keyframes fadeIn{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none}}
</style>
</head>
<body>

<div class="app" id="app">
  
  

  <header class="header">
      <div class="flex-btw nav">
        <!-- fin app logo -->
        <div>
          <a href="./category.html"
            ><img
              src="../assets/images/fin-app-logo.jpg"
              alt="logo"
              width="50px"
          /></a>
        </div>
        <!-- Nav link for dashboard and budget -->
        <ul class="flex-center-lg navlink">
          <li>
            <a href="../dashboard page/dashboard.html">Dashboard</a>
          </li>
          <li>
            <a href="../budget page/budget.html">Budget</a>
          </li>
        </ul>

        <div class="app" id="app">

    
        <!-- user image and clickable items -->
        <div class="menu">
          <div>
            <button class="btn flex-center-sm">
              <img
                src="../assets/images/Jerome Bell.png"
                alt="user"
                width="40px"
                class="user"
              />
              <img
                src="../assets/images/down-arrow.png"
                alt="dropdown-icon"
                width="25px"
              />
            </button>
          </div>
          <!-- desktoplinks which shows when you hover on user image -->
          <div class="hidden flex-col">
            <div class="subcard">
              <p>Septa Academy</p>
              <p>academy.septa@gmail.com</p>
            </div>
            <ul class="flex-col">
              <div>
                <li>
                  <div class="settings-menu">
                    <a href="#" class="flex-btw">
                      Settings
                      <img
                        src="../assets/images/down-arrow.png"
                        alt="dropdown-icon"
                        width="20px"
                      />
                    </a>
                    <div class="hid">
                      <div class="flex-col">
                        <a href="../account/account.html">Account</a>
                        <a href="./category.html">All Categories</a>
                        <a href="../html/card.html">Connected Bank Account</a>
                        <a href="../support/support.html">Support</a>
                      </div>
                    </div>
                  </div>
                </li>
              </div>
              <li>
                <a href="../index.html">Log-out</a>
              </li>
            </ul>
          </div>
        </div>
        <!-- mobile navlinks -->
        <div class="mobile-menu">
          <div>
            <button class="btn menu-btn">
              <img
                src="../assets/images/menu.png"
                alt="dropdown-icon"
                width="30px"
                class="menu-icon"
              />
            </button>
          </div>

          <div class="sidebar">
            <div class="sidebar-link">
              <div class="flex-center-sm user-mobile">
                <img
                  src="../assets/images/Jerome Bell.png"
                  alt="user"
                  width="40px"
                  class="user"
                />
                <p>Septa Academy</p>
              </div>
              <ul class="flex-col">
                    <li>
                    <a href="../dashboard page/dashboard.html">Dashboard</a>
                    </li>
                    <li>
                    <a href="../budget page/budget.html">Budget</a>
                    </li>
                <div>
                  <li>
                    <div id="settings-menu">
                      <a href="#" class="flex-btw">
                        Settings
                        <img
                          src="../assets/images/down-arrow.png"
                          alt="dropdown-icon"
                          width="20px"
                        />
                      </a>
                      <div id="hid">
                        <div class="flex-col">
                          <a href="../account/account.html">Account</a>
                          <a href="./category.html">All Categories</a>
                          <a href="../html/card.html">Connected Bank Account</a>
                          <a href="../support/support.html">Support</a>
                        </div>
                      </div>
                    </div>
                  </li>
                </div>
                <li>
                  <a href="../index.html">Log-out</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
  </header>

    


    <div class="controls">
      <button class="toggle-btn" id="darkToggle" title="Toggle dark mode"></button>
      <-button class="toggle-btn" id="iconsOpenBtn" title="Open icons"></button>
    </div>
  

  <main>
    <!-- LEFT: Add / Edit Form -->
    <section class="card" id="formCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;gap:10px;align-items:center">
          <strong id="formTitle">Create a new category</strong>
          <span class="muted-small" id="formMode"></span>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <h` class="btn secondary" id="loadSample"></h1>
          <h1  id="saveBtn"></h1>
        </div>
      </div>

      <label>Icon</label>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn secondary" id="openIcons">Choose Icon</button>
        <select id="iconSelect" class="input" style="max-width:160px">
          <!-- fallback few -->
          <option value="üíº">üíº Business</option>
          <option value="üíµ">üíµ Money</option>
          <option value="üéÅ">üéÅ Gift</option>
          <option value="üè¶">üè¶ Bank</option>
        </select>
      </div>

      <label>Color</label>
      <input type="color" id="colorInput" value="#2563eb" />

      <label>Name</label>
      <input id="nameInput" class="input" placeholder="New category name" />

      <label>Type</label>
      <select id="typeInput" class="input">
        <option value="income">Income</option>
        <option value="expense">Expense</option>
      </select>

      <label>Transactions count</label>
      <input id="txInput" class="input" type="number" min="0" value="0" />

      <div class="preview" id="livePreview">
        <div class="icon" id="previewIcon" style="background:#2563eb">üíº</div>
        <div>
          <div class="meta" id="previewName">New category</div>
          <div class="muted-small" id="previewMeta">Income ‚Ä¢ 0 transactions</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;">
        <button class="btn" id="confirmSave">Save category</button>
        <button class="btn secondary" id="resetForm">Reset</button>
        <button class="btn danger" id="deleteWhileEdit" style="display:none">Delete</button>
      </div>
    </section>

    <!-- RIGHT: list, search, sort -->
    <section>
      <div class="card">
        <div class="toolbar">
          <input id="search" class="input search" placeholder="Search categories..." />
          <select id="sortSelect" class="input select-inline">
            <option value="alpha">Sort: A ‚Üí Z</option>
            <option value="alpha-desc">Sort: Z ‚Üí A</option>
            <option value="type">Sort: Type</option>
            <option value="txdesc">Sort: Most transactions</option>
          </select>
          <button class="btn secondary" id="mergeModeBtn">Merge categories</button>
          <button class="btn secondary" id="clearAllBtn" title="Clear all categories">Clear all</button>
        </div>

        <div style="margin-top:10px" id="mergeControls" hidden>
          <div class="merge-bar">
            <div class="muted">Selected: <span id="selectedCount">0</span></div>
            <select id="mergeTarget" class="input" style="max-width:220px">
              <!-- filled dynamically -->
            </select>
            <button class="btn" id="doMerge">Merge into target</button>
            <button class="btn secondary" id="cancelMerge">Cancel</button>
          </div>
        </div>

        <div style="margin-top:12px" class="list-area">
          <div class="list-header">
            <div><strong style="color:var(--accent)">Income categories</strong></div>
            <div class="muted-small">Manage income</div>
          </div>
          <div class="list" id="incomeList"></div>

          <div style="height:14px"></div>

          <div class="list-header">
            <div><strong style="color:var(--accent)">Expense categories</strong></div>
            <div class="muted-small">Manage expenses</div>
          </div>
          <div class="list" id="expenseList"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- ICONS MODAL -->
<div class="modal-back" id="iconsModal">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Choose icon</strong>
      <button class="btn secondary" id="closeIcons">Close</button>
    </div>
    <div style="margin-top:8px" class="icon-grid" id="iconGrid"></div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal-back" id="confirmModal">
  <div class="modal" role="dialog">
    <strong id="confirmTitle">Confirm</strong>
    <div id="confirmBody" class="muted-small" style="margin-top:10px">Are you sure?</div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn secondary" id="confirmCancel">Cancel</button>
      <button class="btn danger" id="confirmOk">Confirm</button>
    </div>
  </div>
</div>




<script>
/* -------------------------
   INITIAL DATA & STORAGE
   ------------------------- */
const STORAGE_KEY = 'fintracker_categories_v1';
let categories = []; // {id, icon, color, name, type, tx}
let editId = null;
let mergeMode = false;
let selectedForMerge = new Set();

/* sample icon list (50+). Add more if you want */
const ICONS = ["üíº","üíµ","üéÅ","üè¶","üí≥","üöó","üçî","üéì","üë®‚Äçüë©‚Äçüëß","üè°","üõí","‚úàÔ∏è","üö≤","üì¶","üí°","üßæ","üîß","üìö","üçé","üéâ","üéÆ","üè•","ü™ô","üßë‚Äçüç≥","‚òï","üç∫","üé§","‚öΩ","üñ•Ô∏è","üì±","üîí","üß∞","üõ†Ô∏è","üèñÔ∏è","üõçÔ∏è","üß¥","üíä","üì∑","üßæ","üå±","üíº","üßë‚Äçüè´","ü™ô","üßæ","üîë","ü™ô","üí∞","üéØ","üìà","üìâ","üîã","üßß","üè¶","üëõ","ü™™"];

/* DOM refs */
const incomeList = document.getElementById('incomeList');
const expenseList = document.getElementById('expenseList');
const iconGrid = document.getElementById('iconGrid');
const iconsModal = document.getElementById('iconsModal');
const iconSelect = document.getElementById('iconSelect');
const colorInput = document.getElementById('colorInput');
const nameInput = document.getElementById('nameInput');
const typeInput = document.getElementById('typeInput');
const txInput = document.getElementById('txInput');
const previewIcon = document.getElementById('previewIcon');
const previewName = document.getElementById('previewName');
const previewMeta = document.getElementById('previewMeta');
const confirmModal = document.getElementById('confirmModal');
const confirmTitle = document.getElementById('confirmTitle');
const confirmBody = document.getElementById('confirmBody');
const confirmOk = document.getElementById('confirmOk');
const confirmCancel = document.getElementById('confirmCancel');
const saveBtn = document.getElementById('saveBtn');
const confirmSave = document.getElementById('confirmSave');
const resetForm = document.getElementById('resetForm');
const deleteWhileEdit = document.getElementById('deleteWhileEdit');
const search = document.getElementById('search');
const sortSelect = document.getElementById('sortSelect');
const mergeModeBtn = document.getElementById('mergeModeBtn');
const mergeControls = document.getElementById('mergeControls');
const selectedCount = document.getElementById('selectedCount');
const mergeTarget = document.getElementById('mergeTarget');
const doMerge = document.getElementById('doMerge');
const cancelMerge = document.getElementById('cancelMerge');
const loadSample = document.getElementById('loadSample');
const darkToggle = document.getElementById('darkToggle');
const iconsOpenBtn = document.getElementById('iconsOpenBtn');
const openIcons = document.getElementById('openIcons');
const formTitle = document.getElementById('formTitle');
const formMode = document.getElementById('formMode');
const deleteWhileEditBtn = document.getElementById('deleteWhileEdit');

/* util */
function uid(){ return Math.random().toString(36).slice(2,9); }

function saveToStorage(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(categories));
}

function loadFromStorage(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw) {
    try { categories = JSON.parse(raw) } catch(e){ categories = [] }
  } else {
    // initialize with a few defaults
    categories = [
      {id:uid(), icon:'üíº', color:'#f59e0b', name:'Business', type:'income', tx:0},
      {id:uid(), icon:'üíµ', color:'#16a34a', name:'Salary', type:'income', tx:2},
      {id:uid(), icon:'üéÅ', color:'#8b5cf6', name:'Gifts', type:'income', tx:1},
      {id:uid(), icon:'üè¶', color:'#ef4444', name:'Loan', type:'income', tx:0},
      {id:uid(), icon:'üçî', color:'#10b981', name:'Food and Drink', type:'expense', tx:2},
      {id:uid(), icon:'üöó', color:'#3b82f6', name:'Car', type:'expense', tx:3},
      {id:uid(), icon:'üéì', color:'#64748b', name:'Education', type:'expense', tx:0}
    ];
  }
}

/* -------------------------
   RENDER ICON GRID
   ------------------------- */
function renderIconGrid(){
  iconGrid.innerHTML = '';
  for(const ic of ICONS){
    const el = document.createElement('div');
    el.className = 'icon-tile';
    el.textContent = ic;
    el.title = ic;
    el.onclick = ()=>{
      iconSelect.value = ic;
      closeIconsModal();
      updatePreview();
    };
    iconGrid.appendChild(el);
  }
  // also fill select dropdown with icons (no labels)
  iconSelect.innerHTML = ICONS.map(i=>`<option value="${i}">${i}</option>`).join('');
}

/* -------------------------
   RENDER LISTS
   ------------------------- */
function renderLists(){
  const q = search.value.trim().toLowerCase();
  const sort = sortSelect.value;

  let filtered = categories.filter(c => c.name.toLowerCase().includes(q));
  // sort
  if(sort === 'alpha') filtered.sort((a,b)=>a.name.localeCompare(b.name));
  else if(sort === 'alpha-desc') filtered.sort((a,b)=>b.name.localeCompare(a.name));
  else if(sort === 'type') filtered.sort((a,b)=>a.type.localeCompare(b.type) || b.tx - a.tx);
  else if(sort === 'txdesc') filtered.sort((a,b)=>b.tx - a.tx);

  incomeList.innerHTML = '';
  expenseList.innerHTML = '';

  for(const cat of filtered){
    const wrapper = document.createElement('div');
    wrapper.className = 'category fade-in';
    // left
    const left = document.createElement('div'); left.className = 'left';
    const chk = document.createElement('input'); chk.type='checkbox'; chk.className='checkbox';
    chk.dataset.id = cat.id;
    chk.onchange = onSelectForMerge;
    left.appendChild(chk);

    const icon = document.createElement('div'); icon.className='cat-icon';
    icon.style.background = cat.color; icon.textContent = cat.icon;
    left.appendChild(icon);

    const meta = document.createElement('div'); meta.className='cat-meta';
    const title = document.createElement('div'); title.className='cat-title'; title.textContent = cat.name;
    const sub = document.createElement('div'); sub.className='cat-sub'; sub.innerHTML = `${cat.type.charAt(0).toUpperCase()+cat.type.slice(1)} ‚Ä¢ <span class="muted-small">${cat.tx} transaction${cat.tx===1?'':'s'}</span>`;
    meta.appendChild(title); meta.appendChild(sub);
    left.appendChild(meta);

    // actions
    const actions = document.createElement('div'); actions.className='cat-actions';
    const edit = document.createElement('button'); edit.className='icon-btn'; edit.title='Edit'; edit.innerHTML='‚öôÔ∏è';
    edit.onclick = ()=> startEdit(cat.id);
    const del = document.createElement('button'); del.className='icon-btn'; del.title='Delete'; del.innerHTML='üóëÔ∏è';
    del.onclick = ()=> confirmAction(`Delete "${cat.name}"?`, `This will permanently remove "${cat.name}".`, ()=>{
      categories = categories.filter(x=>x.id!==cat.id);
      saveToStorage(); renderLists();
    });

    actions.appendChild(edit); actions.appendChild(del);

    wrapper.appendChild(left);
    wrapper.appendChild(actions);

    if(cat.type === 'income') incomeList.appendChild(wrapper);
    else expenseList.appendChild(wrapper);
  }

  updateMergeTargetOptions();
}

/* -------------------------
   FORM / PREVIEW / CRUD
   ------------------------- */
function updatePreview(){
  const ic = iconSelect.value;
  const col = colorInput.value;
  const nm = nameInput.value || 'New category';
  const tp = typeInput.value;
  const tx = +txInput.value || 0;
  previewIcon.textContent = ic;
  previewIcon.style.background = col;
  previewName.textContent = nm;
  previewMeta.textContent = `${tp.charAt(0).toUpperCase()+tp.slice(1)} ‚Ä¢ ${tx} transaction${tx===1?'':'s'}`;
}

/* start editing */
function startEdit(id){
  const cat = categories.find(c=>c.id===id);
  if(!cat) return;
  editId = id;
  iconSelect.value = cat.icon;
  colorInput.value = cat.color || '#2563eb';
  nameInput.value = cat.name;
  typeInput.value = cat.type;
  txInput.value = cat.tx;
  formTitle.textContent = 'Edit category';
  formMode.textContent = '(Edit)';
  deleteWhileEdit.style.display = 'inline-block';
  scrollToTop();
  updatePreview();
}

/* reset to add new */
function resetFormFields(){
  editId = null;
  iconSelect.value = ICONS[0];
  colorInput.value = '#2563eb';
  nameInput.value = '';
  typeInput.value = 'income';
  txInput.value = 0;
  formTitle.textContent = 'Create a new category';
  formMode.textContent = '(Add)';
  deleteWhileEdit.style.display = 'none';
  updatePreview();
}

/* confirm before saving edit */
function onConfirmSave(){
  const name = nameInput.value.trim();
  if(name === '') return alert('Enter a name');
  // confirm before applying changes (as user requested Confirm Edit Popup)
  confirmAction(editId ? `Save changes to "${name}"?` : `Create category "${name}"?`,
    editId ? 'Save changes to this category?' : 'Create new category with your settings?',
    ()=>{
      if(editId){
        const idx = categories.findIndex(c=>c.id===editId);
        if(idx>=0){
          categories[idx] = {
            ...categories[idx],
            icon: iconSelect.value,
            color: colorInput.value,
            name: name,
            type: typeInput.value,
            tx: Math.max(0, parseInt(txInput.value)||0)
          };
        }
      } else {
        categories.push({
          id: uid(),
          icon: iconSelect.value,
          color: colorInput.value,
          name: name,
          type: typeInput.value,
          tx: Math.max(0, parseInt(txInput.value)||0)
        });
      }
      saveToStorage();
      resetFormFields();
      renderLists();
    }
  );
}

/* delete while editing */
function onDeleteWhileEditing(){
  if(!editId) return;
  const cat = categories.find(c=>c.id===editId);
  if(!cat) return;
  confirmAction(`Delete "${cat.name}"?`, 'This will permanently delete this category.', ()=>{
    categories = categories.filter(c=>c.id!==editId);
    saveToStorage();
    resetFormFields();
    renderLists();
  });
}

/* -------------------------
   MERGE LOGIC
   ------------------------- */
function toggleMergeMode(){
  mergeMode = !mergeMode;
  selectedForMerge.clear();
  mergeControls.hidden = !mergeMode;
  mergeModeBtn.textContent = mergeMode ? 'Merging...' : 'Merge categories';
  renderLists();
}

function onSelectForMerge(e){
  const id = e.target.dataset.id;
  if(e.target.checked) selectedForMerge.add(id);
  else selectedForMerge.delete(id);
  selectedCount.textContent = selectedForMerge.size;
}

function updateMergeTargetOptions(){
  // fill merge target with all categories except selected ones (or all if none selected)
  mergeTarget.innerHTML = '';
  for(const c of categories){
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = `${c.name} (${c.type}, ${c.tx})`;
    mergeTarget.appendChild(opt);
  }
}

function doMergeAction(){
  const toId = mergeTarget.value;
  if(!toId) return alert('Select a target');
  if(selectedForMerge.size === 0) return alert('Select at least one category to merge');
  if(selectedForMerge.has(toId)) return alert('Cannot merge target into itself');

  const target = categories.find(c=>c.id===toId);
  if(!target) return;

  confirmAction(`Merge categories into "${target.name}"?`,
    `This will move transactions from ${selectedForMerge.size} selected categories into "${target.name}" and delete the source categories.`,
    ()=>{
      // combine tx counts + delete selected
      let moved = 0;
      for(const id of Array.from(selectedForMerge)){
        const src = categories.find(c=>c.id===id);
        if(!src || src.id===toId) continue;
        moved += src.tx;
        categories = categories.filter(x=>x.id!==id);
      }
      // add moved transactions to target
      target.tx = (target.tx || 0) + moved;
      saveToStorage();
      selectedForMerge.clear();
      toggleMergeMode(); // disable merge mode
      renderLists();
    }
  );
}

/* -------------------------
   CONFIRM MODAL UTIL
   ------------------------- */
function confirmAction(title, body, onOk){
  confirmTitle.textContent = title;
  confirmBody.textContent = body;
  confirmModal.style.display = 'flex';
  confirmOk.onclick = ()=>{
    confirmModal.style.display = 'none';
    onOk && onOk();
  };
  confirmCancel.onclick = ()=> confirmModal.style.display = 'none';
}

/* -------------------------
   ICONS MODAL
   ------------------------- */
function openIconsModal(){
  iconsModal.style.display = 'flex';
}
function closeIconsModal(){ iconsModal.style.display = 'none' }

/* -------------------------
   EVENTS
   ------------------------- */
document.addEventListener('click', (ev)=>{
  if(ev.target === iconsModal) closeIconsModal();
  if(ev.target === confirmModal) confirmModal.style.display = 'none';
});

openIcons.onclick = openIconsModal;
iconsOpenBtn.onclick = openIconsModal;
document.getElementById('closeIcons').onclick = closeIconsModal;

iconSelect.onchange = updatePreview;
colorInput.oninput = updatePreview;
nameInput.oninput = updatePreview;
typeInput.onchange = updatePreview;
txInput.oninput = updatePreview;

search.oninput = renderLists;
sortSelect.onchange = renderLists;

confirmSave.onclick = onConfirmSave;
saveBtn.onclick = ()=>{ /* scroll to form */ document.getElementById('formCard').scrollIntoView({behavior:'smooth'}) };
resetForm.onclick = resetFormFields;
deleteWhileEdit.onclick = onDeleteWhileEditing;

mergeModeBtn.onclick = toggleMergeMode;
doMerge.onclick = doMergeAction;
cancelMerge.onclick = ()=>{ selectedForMerge.clear(); toggleMergeMode(); }

loadSample.onclick = ()=>{
  // add some sample categories
  categories.push({id:uid(), icon:'üßæ', color:'#8b5cf6', name:'Freelance', type:'income', tx:4});
  categories.push({id:uid(), icon:'üõçÔ∏è', color:'#ef4444', name:'Shopping', type:'expense', tx:5});
  saveToStorage(); renderLists();
};

document.getElementById('clearAllBtn').onclick = ()=>{
  confirmAction('Clear ALL categories?', 'This will remove all categories and reset to empty.', ()=>{
    categories = [];
    saveToStorage(); renderLists(); resetFormFields();
  });
};

/* delete while editing button */
deleteWhileEditBtn.onclick = onDeleteWhileEditing;

/* keyboard: Enter on search does nothing special; Enter in form saves */
document.getElementById('app').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && (document.activeElement === nameInput || document.activeElement === txInput)){
    onConfirmSave();
  }
});

/* dark mode */
(function(){
  const saved = localStorage.getItem('fintracker_theme');
  if(saved) document.documentElement.setAttribute('data-theme', saved);
  darkToggle.onclick = ()=>{
    const cur = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light':'dark';
    document.documentElement.setAttribute('data-theme', cur==='dark'?'dark':'');
    localStorage.setItem('fintracker_theme', cur==='dark'?'dark':'');
  }
})();

/* icons modal populate */
renderIconGrid();

/* initial load */
loadFromStorage();
renderLists();
resetFormFields();
updatePreview();

/* update preview on load too */
updatePreview();

/* expose save to Save button in header: scroll to form */
saveBtn.addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));

/* to make checkboxes work during merge mode: intercept list render checkboxes */
incomeList.addEventListener('change', (e)=>{ if(e.target.matches('.checkbox')) onSelectForMerge(e) });
expenseList.addEventListener('change', (e)=>{ if(e.target.matches('.checkbox')) onSelectForMerge(e) });

</script>
</body>
</html>
