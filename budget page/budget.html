<!doctype html>
<html lang="en">
<head>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="keywords" content="expense tracker, budget help," />
    <meta
      name="description"
      content="The modern app that help you prepare your budget limit, track your monthly expenses and mitigate financial risk."
    />
    <title>FinTracker</title>
    <link rel="stylesheet" href="budget.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/feather-icons@4.29.0/dist/feather.css"
    />
    <link href="../assets/images/updated-logo.jpg" rel="icon" type="image/png" />
    <link rel="stylesheet" href="../style.css" />
    <script src="../script.js" defer></script>
    <script type="module" src="./budget.js"></script>
  
<style>
  :root{
    --bg:#f4f6f8; --panel:#fff; --muted:#8b95a1; --accent:#009f4d; --danger:#e53935;
    --card-shadow: 0 4px 18px rgba(15,20,25,0.06);
  }
  [data-theme="dark"]{
    --bg:#0f1720; --panel:#0b1116; --muted:#9aa8b6; --accent:#2bd77a; --danger:#ff6b6b;
    --card-shadow: 0 6px 24px rgba(0,0,0,0.6);
  }

  *{box-sizing:border-box}
  body{
    margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg); color: #0b1220; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  [data-theme="dark"] body { color: #e6eef6; }

  header{
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 18px; background:var(--panel); box-shadow:var(--card-shadow);
    position:sticky; top:0; z-index:50;
  }
  .brand{display:flex; gap:12px; align-items:center}
  .logo {
    width:44px; height:44px; border-radius:8px; background:linear-gradient(135deg,#0fbf6c,#0b8b56);
    display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700;
  }
  .title { font-size:18px; font-weight:700; }
  .controls { display:flex; gap:8px; align-items:center; }

  .container{max-width:1100px; margin:18px auto; padding:0 18px;}

  .top-grid { display:grid; grid-template-columns: 1fr; gap:16px; margin-bottom:18px; }
  @media(min-width:900px){ .top-grid{grid-template-columns: 360px 1fr;} }

  .panel { background:var(--panel); border-radius:12px; padding:16px; box-shadow:var(--card-shadow); }

  /* Left panel (create + filters + summary) */
  .left-col .panel { margin-bottom:16px; }
  .btn { background:var(--accent); color:#fff; border:0; padding:10px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
  .btn.ghost { background:transparent; color:var(--accent); border:1px solid rgba(0,0,0,0.06); }
  .field { margin-top:12px; display:flex; flex-direction:column; gap:8px; }
  input[type="text"], input[type="number"], input[type="date"], select, textarea {
    padding:10px; border-radius:8px; border:1px solid #d3d9df; background:transparent; outline:none;
  }
  label.small { font-size:13px; color:var(--muted); }

  /* Dashboard / Budgets list */
  .dashboard { display:grid; grid-template-columns: repeat(1,1fr); gap:14px; }
  @media(min-width:700px){ .dashboard { grid-template-columns: repeat(2,1fr); } }
  @media(min-width:1100px){ .dashboard { grid-template-columns: repeat(3,1fr); } }

  .budget-card { padding:14px; border-radius:12px; display:flex; flex-direction:column; gap:10px; }
  .row { display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .small-muted { color:var(--muted); font-size:13px; }

  .progress-wrap { background: #eef3f6; border-radius:999px; height:10px; overflow:hidden; }
  .progress-bar { height:100%; width:0%; background:var(--accent); border-radius:999px; transition:width .4s ease; }

  .actions { display:flex; gap:8px; }
  .action-btn { padding:8px 10px; border-radius:8px; border:0; cursor:pointer; font-weight:600; }
  .edit-btn { background:#ffcc00; color:#0b1220; }
  .del-btn { background:var(--danger); color:#fff; }
  .expense-btn { background:#2b9df7; color:#fff; }

  /* Modal */
  .modal-backdrop { position:fixed; inset:0; background:rgba(2,6,23,0.45); display:none; align-items:center; justify-content:center; z-index:120; padding:20px; }
  .modal { width:100%; max-width:560px; background:var(--panel); border-radius:12px; padding:18px; box-shadow:var(--card-shadow); max-height:90vh; overflow:auto; }
  .modal .row { margin-bottom:8px; }

  /* budget list row in table style */
  .list-panel { display:flex; flex-direction:column; gap:12px; }
  .list-item { display:flex; gap:12px; align-items:center; padding:12px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border:1px solid rgba(0,0,0,0.03); }
  .cat-badge { width:44px; height:44px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:18px; }
  .list-item .meta { flex:1; display:flex; flex-direction:column; gap:6px; }
  .meta strong { font-size:15px; }
  .tiny { font-size:12px; color:var(--muted); }
  .search-row { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
  .select, .search { padding:9px; border-radius:8px; border:1px solid #cfd8df; }

  .summary { display:flex; gap:8px; align-items:center; justify-content:space-between; }
  .summary .box { flex:1; padding:12px; border-radius:10px; background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent); text-align:center; }
  .summary strong { display:block; font-size:18px; margin-top:6px; }

  footer { text-align:center; padding:24px 0; color:var(--muted); font-size:13px; }

  /* small helpers */
  .muted { color:var(--muted); font-size:13px; }
  .icon { font-size:18px; margin-right:6px; }

</style>
</head>
<body >

    <header class="header">
      <div class="flex-btw nav">
        <!-- fin app logo -->
        <div>
          <a href="./budget.html"
            ><img
              src="../assets/images/updated-logo.jpg"
              alt="logo"
              width="50px"
          /></a>
        </div>
        <!-- Nav link for dashboard and budget -->
        <ul class="flex-center-lg navlink">
          <li>
            <a href="../dashboard page/dashboard.html">Dashboard</a>
          </li>
          <li>
            <a href="../budget page/budget.html">Budget</a>
          </li>
        </ul>
        <!-- user image and clickable items -->
        <div class="menu">
          <div>
            <button class="btn flex-center-sm">
              <img
                src="../assets/images/Jerome Bell.png"
                alt="user"
                width="40px"
                class="user"
              />
              <img
                src="../assets/images/down-arrow.png"
                alt="dropdown-icon"
                width="25px"
              />
            </button>
          </div>
          <!-- links which shows when you hover on user image -->
          <div class="hidden flex-col">
            <div class="subcard">
              <p>Septa Academy</p>
              <p>academy.septa@gmail.com</p>
            </div>
            <ul class="flex-col">
              <div>
                <li>
                  <div class="settings-menu">
                    <a href="#" class="flex-btw">
                      Settings
                      <img
                        src="../assets/images/down-arrow.png"
                        alt="dropdown-icon"
                        width="20px"
                      />
                    </a>
                    <div class="hid">
                      <div class="flex-col">
                        <a href="../account/account.html">Account</a>
                        <a href="../categories/category.html">All Categories</a>
                        <a href="../html/card.html">Connected Bank Account</a>
                        <a href="../support/support.html">Support</a>
                      </div>
                    </div>
                  </div>
                </li>
              </div>
              <li>
                <a href="../index.html">Log-out</a>
              </li>
            </ul>
          </div>
        </div>
        <!-- mobile navlinks -->
        <div class="mobile-menu">
          <div>
            <button class="btn menu-btn">
              <img
                src="../assets/images/menu.png"
                alt="dropdown-icon"
                width="30px"
                class="menu-icon"
              />
            </button>
          </div>

          <div class="sidebar">
            <div class="sidebar-link">
              <div class="flex-center-sm user-mobile">
                <img
                  src="../assets/images/Jerome Bell.png"
                  alt="user"
                  width="40px"
                  class="user"
                />
                <p>Septa Academy</p>
              </div>
              <ul class="flex-col">
                <li>
                  <a href="../dashboard page/dashboard.html">Dashboard</a>
                </li>
                <li>
                  <a href="../budget page/budget.html">Budget</a>
                </li>
                <div>
                  <li>
                    <div id="settings-menu">
                      <a href="#" class="flex-btw">
                        Settings
                        <img
                          src="../assets/images/down-arrow.png"
                          alt="dropdown-icon"
                          width="20px"
                        />
                      </a>
                      <div id="hid">
                        <div class="flex-col">
                          <a href="../account/account.html">Account</a>
                          <a href="../categories/category.html">All Categories</a>
                          <a href="../html/card.html">Connected Bank Account</a>
                          <a href="../support/support.html">Support</a>
                        </div>
                      </div>
                    </div>
                  </li>
                </div>
                <li>
                  <a href="../index.html">Log-out</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </header>



<main class="container">
  <div class="top-grid">
    <div class="left-col">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Create Budget</strong><div class="small-muted">Add budgets, set amount and start date</div></div>
        </div>

        <div class="field">
          <label class="small">Name</label>
          <input id="quickName" placeholder="e.g. Groceries">
        </div>

        <div class="field">
          <label class="small">Amount</label>
          <input id="quickAmount" type="number" placeholder="1000">
        </div>

        <div style="display:flex; gap:8px;">
          <div style="flex:1">
            <div class="field">
              <label class="small">Currency</label>
              <select id="quickCurrency">
                <option>USD</option><option>EUR</option><option>NGN</option><option>GBP</option>
              </select>
            </div>
          </div>
          <div style="flex:1">
            <div class="field">
              <label class="small">Category</label>
              <select id="quickCategory">
                <option>All Categories</option>
                <option>Food</option><option>Transport</option><option>Shopping</option><option>Bills</option>
              </select>
            </div>
          </div>
        </div>

      <div class="field">
        <label class="small">Recurrence</label>
        <div style="display:flex; gap:8px;">
          <button class="rec" data-val="Once">Once</button>
          <button class="rec" data-val="Daily">Daily</button>
          <button class="rec" data-val="Weekly">Weekly</button>
          <button class="rec" data-val="Biweekly">Biweekly</button>
          <button class="rec" data-val="monthly">Monthly</button>
          <!--button class="rec" data-val="quarterly">Quarterly</button>
          <button class="rec" data-val="yearly">yearly</button-->
        </div>
      </div>

        <div style="display:flex; gap:8px; margin-top:12px;">
          <button class="btn" id="btnCreateQuick">Create Budget</button>
          <!--button class="btn ghost" id="btnOpenAdvanced">Advanced</button-->
        </div>
      </div>

      <div class="panel">
        <strong>Filters & Search</strong>
        <div class="search-row" style="margin-top:10px">
          <input id="searchInput" class="search" placeholder="Search budgets by name..." />
          <select id="filterCategory" class="select">
            <option value="">All categories</option>
            <option>All Categories</option><option>Food</option><option>Transport</option><option>Shopping</option><option>Bills</option>
          </select>
        </div>

        <div style="display:flex; gap:8px; margin-top:10px;">
          <select id="filterRecurrence" class="select">
            <option value="">All recurrence</option>
            <option>Once</option><option>Daily</option><option>Weekly</option><option>Biweekly</option>
          </select>
          <select id="sortBy" class="select">
            <option value="newest">Sort: Newest</option>
            <option value="oldest">Oldest</option>
            <option value="amount-asc">Amount ‚Üë</option>
            <option value="amount-desc">Amount ‚Üì</option>
            <option value="progress-desc">Progress ‚Üì</option>
          </select>
        </div>

        <div style="margin-top:12px;">
          <strong>Overview</strong>
          <div class="summary" style="margin-top:10px;">
            <div class="box">
              <div class="muted">Total budgets</div>
              <strong id="summaryCount">0</strong>
            </div>
            <div class="box">
              <div class="muted">Total allocated</div>
              <strong id="summaryTotal">0</strong>
            </div>
            <div class="box">
              <div class="muted">Spent</div>
              <strong id="summarySpent">0</strong>
            </div>
          </div>
        </div>
      </div>

    </div>

    <div>
      <div style="display:flex; justify-content:space-between; gap:12px; margin-bottom:12px; align-items:center">
        <div>
          <h2 style="margin:0">Budgets</h2>
          <div class="muted" style="margin-top:6px">Manage budgets, track spending and progress</div>
        </div>

        <div style="display:flex; gap:8px; align-items:center">
          <button id="btnExpandAll" class="btn ghost">Expand all</button>
          <!--button id="openCreateTop" class="btn">+ New</button-->
        </div>
      </div>

      <div class="panel list-panel" id="listPanel">
        <!-- budget items inserted here -->
      </div>

      <div class="panel" style="margin-top:12px;">
        <strong>Dashboard</strong>
        <div style="margin-top:12px" id="dashboardGrid" class="dashboard">
          <!-- summary cards -->
        </div>
      </div>

    </div>
  </div>
</main>

<!-- Modal for Create/Edit/Expense -->
<div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <strong id="modalTitle">New Budget</strong>
      <div style="display:flex; gap:8px;">
        <button id="closeModal" class="btn ghost">Close</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="field">
        <label class="small">Budget name</label>
        <input id="mName" placeholder="e.g. Groceries">
      </div>

      <div class="field">
        <label class="small">Amount</label>
        <input id="mAmount" type="number" placeholder="1000">
      </div>

      <div style="display:flex; gap:8px;">
        <div style="flex:1" class="field">
          <label class="small">Currency</label>
          <select id="mCurrency"><option>USD</option><option>EUR</option><option>NGN</option><option>GBP</option></select>
        </div>
        <div style="flex:1" class="field">
          <label class="small">Category</label>
          <select id="mCategory"><option>All Categories</option><option>Food</option><option>Transport</option><option>Shopping</option><option>Bills</option></select>
        </div>
      </div>

     

      <div class="field">
        <label class="small">Start date</label>
        <input id="mDate" type="date">
      </div>

      <div style="display:flex; gap:8px; margin-top:12px;">
        <button id="saveModal" class="btn">Save</button>
        <button id="deleteFromModal" class="btn del-btn" style="display:none">Delete</button>
      </div>

      <hr style="margin:14px 0; border:none; border-top:1px solid rgba(0,0,0,0.06)">

      <div id="expenseBlock" style="display:none">
        <strong>Expenses for this budget</strong>
        <div style="margin-top:10px; display:flex; gap:8px;">
          <input id="expAmount" placeholder="Amount" type="number" style="flex:1">
          <input id="expDate" type="date" style="width:160px">
        </div>
        <div style="margin-top:8px;">
          <input id="expNote" placeholder="Note (optional)">
        </div>
        <div style="margin-top:8px;">
          <button id="addExpenseBtn" class="btn expense-btn">Add expense</button>
        </div>

        <div id="expensesList" style="margin-top:12px; display:flex; flex-direction:column; gap:8px;"></div>
      </div>
    </div>
  </div>
</div>

 <!--div class="controls">
    <button id="themeToggle" class="btn ghost" title="Toggle theme">üåô</button>
    <button id="openCreate" class="btn">+ New Budget</button>
</div-->

<footer>
     

</footer>

<script>
/* ---------- Utilities & state ---------- */
const LS_KEY = 'fintrackr_budgets_v1';
let budgets = JSON.parse(localStorage.getItem(LS_KEY) || '[]'); // each: {id,name,amount,currency,category,recurrence,date,expenses: [{id,amt,date,note}], createdAt}
let editingId = null;
let selectedRecurrence = '';
const categoryIcons = {
  "All Categories":"üóÇÔ∏è",
  "Food":"üçî",
  "Transport":"üöå",
  "Shopping":"üõçÔ∏è",
  "Bills":"üí°"
};
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

/* ---------- Helpers ---------- */
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(budgets));
}
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }
function formatCurrency(cur, amt){
  // simple formatting
  return cur + ' ' + Number(amt).toLocaleString();
}
function totalAllocated(){ return budgets.reduce((s,b)=>s + Number(b.amount || 0), 0); }
function totalSpent(){ return budgets.reduce((s,b)=> s + b.expenses.reduce((x,e)=> x + Number(e.amt||0),0),0); }

/* ---------- Rendering ---------- */
function renderList(){
  const panel = $('#listPanel');
  panel.innerHTML = '';
  const search = $('#searchInput').value.trim().toLowerCase();
  const catFilter = $('#filterCategory').value;
  const recFilter = $('#filterRecurrence').value;
  const sortBy = $('#sortBy').value;

  let list = budgets.slice();

  if (search) list = list.filter(b => b.name.toLowerCase().includes(search));
  if (catFilter) list = list.filter(b => b.category === catFilter);
  if (recFilter) list = list.filter(b => b.recurrence === recFilter);

  // compute progress
  list = list.map(b => {
    const spent = b.expenses.reduce((s,e)=> s + Number(e.amt||0), 0);
    const progress = b.amount ? Math.min(100, Math.round((spent / b.amount) * 100)) : 0;
    return {...b, spent, progress};
  });

  // sort
  if (sortBy === 'amount-asc') list.sort((a,b)=> a.amount - b.amount);
  else if (sortBy === 'amount-desc') list.sort((a,b)=> b.amount - a.amount);
  else if (sortBy === 'oldest') list.sort((a,b)=> new Date(a.createdAt) - new Date(b.createdAt));
  else if (sortBy === 'progress-desc') list.sort((a,b)=> b.progress - a.progress);
  else list.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));

  if (list.length === 0){
    panel.innerHTML = '<div class="muted" style="padding:18px; text-align:center">No budgets yet ‚Äî create one to get started.</div>';
    renderSummary();
    renderDashboard();
    return;
  }

  list.forEach(b => {
    const card = document.createElement('div');
    card.className = 'list-item budget-card panel';
    card.innerHTML = `
      <div style="display:flex; gap:12px; align-items:center; flex:1;">
        <div class="cat-badge" style="background:linear-gradient(135deg, rgba(0,0,0,0.03), transparent);">
          <div style="font-size:20px">${categoryIcons[b.category] || 'üìÅ'}</div>
        </div>
        <div class="meta" style="flex:1">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <strong>${escapeHtml(b.name)}</strong>
              <div class="tiny">${b.category} ‚Ä¢ ${b.recurrence} ‚Ä¢ starts ${b.date}</div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:700">${b.currency} ${Number(b.amount).toLocaleString()}</div>
              <div class="tiny">Allocated</div>
            </div>
          </div>

          <div style="margin-top:8px">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px">
              <div style="flex:1; margin-right:12px;">
                <div class="progress-wrap" aria-hidden="true">
                  <div class="progress-bar" style="width:${b.progress}%"></div>
                </div>
                <div class="tiny" style="margin-top:6px">${b.progress}% used ‚Äî ${b.currency} ${Number(b.spent).toLocaleString()} spent</div>
              </div>
              <div style="min-width:120px; display:flex; flex-direction:column; gap:6px;">
                <div style="display:flex; gap:8px;">
                  <button class="action-btn edit-btn" data-id="${b.id}">Edit</button>
                  <button class="action-btn expense-btn" data-id="${b.id}">Add Expense</button>
                </div>
                <div><button class="action-btn del-btn" data-id="${b.id}">Delete</button></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    panel.appendChild(card);
  });

  // attach listeners
  $$('.edit-btn').forEach(btn => btn.onclick = ()=> openModal('edit', btn.dataset.id));
  $$('.del-btn').forEach(btn => btn.onclick = ()=> {
    if (!confirm('Delete this budget?')) return;
    deleteBudget(btn.dataset.id);
  });
  $$('.expense-btn').forEach(btn => btn.onclick = ()=> openModal('expense', btn.dataset.id));

  renderSummary();
  renderDashboard();
}

function renderSummary(){
  $('#summaryCount').innerText = budgets.length;
  $('#summaryTotal').innerText = formatCurrency('', totalAllocated());
  $('#summarySpent').innerText = formatCurrency('', totalSpent());
}

function renderDashboard(){
  const grid = $('#dashboardGrid');
  grid.innerHTML = '';
  if (budgets.length === 0){
    grid.innerHTML = '<div class="muted" style="padding:10px">No dashboard data yet.</div>';
    return;
  }
  // show up to 9 cards
  budgets.slice(0,9).forEach(b => {
    const spent = b.expenses.reduce((s,e)=> s + Number(e.amt||0), 0);
    const percent = b.amount ? Math.min(100, Math.round((spent / b.amount)*100)) : 0;
    const card = document.createElement('div');
    card.className = 'panel budget-card';
    card.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; gap:12px; align-items:center">
          <div class="cat-badge">${categoryIcons[b.category]||'üìÅ'}</div>
          <div>
            <strong>${escapeHtml(b.name)}</strong>
            <div class="tiny">${b.category}</div>
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:700">${b.currency} ${Number(b.amount).toLocaleString()}</div>
          <div class="tiny">Allocated</div>
        </div>
      </div>
      <div style="margin-top:10px">
        <div class="progress-wrap"><div class="progress-bar" style="width:${percent}%"></div></div>
        <div class="tiny" style="margin-top:8px">${percent}% ‚Ä¢ Spent ${b.currency} ${Number(spent).toLocaleString()}</div>
      </div>
    `;
    grid.appendChild(card);
  });
}

/* ---------- CRUD ---------- */
function createBudget(payload){
  const b = {
    id: uid('b'),
    name: payload.name,
    amount: Number(payload.amount),
    currency: payload.currency,
    category: payload.category,
    recurrence: payload.recurrence,
    date: payload.date,
    createdAt: new Date().toISOString(),
    expenses: payload.expenses || []
  };
  budgets.unshift(b);
  saveState();
  renderList();
  return b.id;
}
function updateBudget(id, payload){
  const idx = budgets.findIndex(x => x.id === id); if (idx === -1) return;
  budgets[idx] = {...budgets[idx], ...payload};
  saveState(); renderList();
}
function deleteBudget(id){
  budgets = budgets.filter(b => b.id !== id);
  saveState();
  renderList();
}

/* ---------- Modal logic ---------- */
const modal = $('#modalBackdrop');
const recButtons = $$('.rec');

function openModal(mode='create', id=null){
  editingId = id;
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');

  // reset rec buttons
  recButtons.forEach(btn => btn.style.background='transparent');

  if (mode === 'create'){
    $('#modalTitle').innerText = 'New Budget';
    $('#mName').value = ''; $('#mAmount').value=''; $('#mCurrency').value='USD';
    $('#mCategory').value='All Categories'; $('#mDate').value = new Date().toISOString().slice(0,10);
    selectedRecurrence = 'Once'; setRecButton('Once');
    $('#saveModal').style.display = 'inline-block';
    $('#deleteFromModal').style.display = 'none';
    $('#expenseBlock').style.display = 'none';
  } else {
    const b = budgets.find(x=> x.id === id);
    if (!b) return;
    if (mode === 'edit'){
      $('#modalTitle').innerText = 'Edit Budget';
      $('#mName').value = b.name; $('#mAmount').value = b.amount; $('#mCurrency').value = b.currency;
      $('#mCategory').value = b.category; $('#mDate').value = b.date;
      selectedRecurrence = b.recurrence; setRecButton(b.recurrence);
      $('#saveModal').style.display = 'inline-block';
      $('#deleteFromModal').style.display = 'inline-block';
      $('#expenseBlock').style.display = 'block';
      renderExpenses(b.id);
    } else if (mode === 'expense'){
      $('#modalTitle').innerText = 'Add Expense';
      $('#saveModal').style.display = 'none';
      $('#deleteFromModal').style.display = 'none';
      $('#expenseBlock').style.display = 'block';
      // show budget basic info in modal
      $('#mName').value = b.name; $('#mAmount').value = b.amount; $('#mCurrency').value = b.currency;
      $('#mCategory').value = b.category; $('#mDate').value = b.date;
      selectedRecurrence = b.recurrence; setRecButton(b.recurrence);
      renderExpenses(b.id);
    }
  }
}

function closeModal(){
  modal.style.display = 'none';
  editingId = null;
  $('#expAmount').value=''; $('#expNote').value=''; $('#expDate').value='';
}

$$('.rec').forEach(btn => {
  btn.addEventListener('click', e => {
    const v = btn.dataset.val;
    selectedRecurrence = v;
    setRecButton(v);
  });
});
function setRecButton(v){
  recButtons.forEach(btn => btn.style.background = (btn.dataset.val === v) ? 'var(--accent)' : 'transparent');
  recButtons.forEach(btn => btn.style.color = (btn.dataset.val === v) ? '#fff' : '');
}

/* Save and Delete from modal */
$('#saveModal').addEventListener('click', ()=>{
  const payload = {
    name: $('#mName').value.trim(),
    amount: Number($('#mAmount').value || 0),
    currency: $('#mCurrency').value,
    category: $('#mCategory').value,
    recurrence: selectedRecurrence || 'Once',
    date: $('#mDate').value || new Date().toISOString().slice(0,10)
  };
  if (!payload.name || !payload.amount){ alert('Please enter name and amount'); return; }

  if (editingId){
    updateBudget(editingId, payload);
  } else {
    createBudget(payload);
  }
  closeModal();
});

$('#deleteFromModal').addEventListener('click', ()=>{
  if (!editingId) return;
  if (!confirm('Delete this budget (and its expenses)?')) return;
  deleteBudget(editingId);
  closeModal();
});

/* Expenses */
function renderExpenses(bid){
  const target = $('#expensesList');
  target.innerHTML = '';
  const b = budgets.find(x => x.id === bid);
  if (!b) return;
  if (!b.expenses) b.expenses = [];
  b.expenses.slice().reverse().forEach(e => {
    const row = document.createElement('div');
    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
    row.style.padding='8px'; row.style.borderRadius='8px'; row.style.background='rgba(0,0,0,0.03)';
    row.innerHTML = `<div><strong>${b.currency} ${Number(e.amt).toLocaleString()}</strong><div class="tiny">${e.date} ‚Ä¢ ${escapeHtml(e.note||'')}</div></div>
      <div style="display:flex; gap:8px">
        <button class="btn ghost" data-b="${bid}" data-e="${e.id}">Edit</button>
        <button class="btn del-btn" data-b="${bid}" data-e="${e.id}">Delete</button>
      </div>`;
    target.appendChild(row);
  });

  // attach expense edit/delete listeners
  target.querySelectorAll('button[data-e]').forEach(btn=>{
    btn.onclick = (ev)=>{
      const bId = btn.dataset.b, eId = btn.dataset.e;
      if (btn.innerText.toLowerCase().includes('edit')){
        // populate exp inputs for edit
        const bObj = budgets.find(x=>x.id===bId);
        const eObj = bObj.expenses.find(x=>x.id===eId);
        $('#expAmount').value = eObj.amt; $('#expDate').value = eObj.date; $('#expNote').value = eObj.note || '';
        $('#addExpenseBtn').dataset.edit = JSON.stringify({bId,eId});
      } else {
        if (!confirm('Delete this expense?')) return;
        removeExpense(bId, eId);
        renderExpenses(bId);
        renderList();
      }
    };
  });
}

$('#addExpenseBtn').addEventListener('click', ()=>{
  const amt = Number($('#expAmount').value || 0);
  const date = $('#expDate').value || new Date().toISOString().slice(0,10);
  const note = $('#expNote').value.trim();
  if (!amt || amt <= 0){ alert('Enter a positive amount'); return; }

  // if editing expense
  if ($('#addExpenseBtn').dataset.edit){
    const ed = JSON.parse($('#addExpenseBtn').dataset.edit);
    editExpense(ed.bId, ed.eId, {amt,date,note});
    $('#addExpenseBtn').removeAttribute('data-edit');
  } else {
    // add expense to currently opened budget (editingId)
    const targetId = editingId || null;
    if (!targetId){ alert('No budget selected'); return; }
    addExpense(targetId, {amt,date,note});
  }

  $('#expAmount').value=''; $('#expDate').value=''; $('#expNote').value='';
  renderExpenses(editingId);
  renderList();
});

/* expense operations */
function addExpense(bid, obj){
  const b = budgets.find(x=> x.id === bid); if (!b) return;
  if (!b.expenses) b.expenses = [];
  b.expenses.push({ id: uid('e'), amt: Number(obj.amt), date: obj.date, note: obj.note });
  saveState();
}
function removeExpense(bid, eid){
  const b = budgets.find(x=> x.id === bid); if (!b) return;
  b.expenses = b.expenses.filter(x=> x.id !== eid);
  saveState();
}
function editExpense(bid, eid, payload){
  const b = budgets.find(x=> x.id === bid); if (!b) return;
  const idx = b.expenses.findIndex(x=> x.id === eid); if (idx===-1) return;
  b.expenses[idx] = {...b.expenses[idx], amt: Number(payload.amt), date: payload.date, note: payload.note};
  saveState();
}

/* ---------- Quick create & top controls ---------- */
$('#btnCreateQuick').addEventListener('click', ()=>{
  const name = $('#quickName').value.trim();
  const amount = Number($('#quickAmount').value || 0);
  const currency = $('#quickCurrency').value;
  const category = $('#quickCategory').value;
  if (!name || !amount){ alert('Please enter name and amount'); return; }
  createBudget({name,amount,currency,category,recurrence:'Monthly',date:new Date().toISOString().slice(0,10)});
  $('#quickName').value=''; $('#quickAmount').value='';
  alert('Budget created');
});

$('#openCreate').addEventListener('click', ()=> openModal('create'));
$('#openCreateTop').addEventListener('click', ()=> openModal('create'));
$('#btnOpenAdvanced').addEventListener('click', ()=> openModal('create'));
$('#closeModal').addEventListener('click', ()=> closeModal());
$('#modalBackdrop').addEventListener('click', (e)=> { if (e.target === modal) closeModal(); });

$('#searchInput').addEventListener('input', renderList);
$('#filterCategory').addEventListener('change', renderList);
$('#filterRecurrence').addEventListener('change', renderList);
$('#sortBy').addEventListener('change', renderList);
$('#btnExpandAll').addEventListener('click', ()=> {
  // simple scroll to top of list
  document.querySelector('#listPanel')?.scrollIntoView({behavior:'smooth'});
});

/* Theme toggle */
const themeToggle = $('#themeToggle');
function applyTheme(t){
  document.documentElement.setAttribute('data-theme', t);
  localStorage.setItem('fin_theme', t);
  themeToggle.innerText = t === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}
themeToggle.addEventListener('click', ()=>{
  const current = document.documentElement.getAttribute('data-theme') || 'light';
  applyTheme(current === 'light' ? 'dark' : 'light');
});
const savedTheme = localStorage.getItem('fin_theme') || 'light';
applyTheme(savedTheme);

/* Escape HTML utility */
function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ---------- initialize demo / load ---------- */
function initDemoIfEmpty(){
  if (budgets.length > 0) return;
  // sample budgets
  createBudget({name:'Groceries', amount:500, currency:'USD', category:'Food', recurrence:'Weekly', date: new Date().toISOString().slice(0,10), expenses: [{id: uid('e'), amt:120, date: new Date().toISOString().slice(0,10), note:'Walmart'}]});
  createBudget({name:'Transport', amount:200, currency:'USD', category:'Transport', recurrence:'Monthly', date: new Date().toISOString().slice(0,10), expenses: []});
  createBudget({name:'Utilities', amount:150, currency:'USD', category:'Bills', recurrence:'Monthly', date: new Date().toISOString().slice(0,10), expenses: [{id: uid('e'), amt:60, date: new Date().toISOString().slice(0,10), note:'Electric'}]});
}

initDemoIfEmpty();
renderList();

/* ---------- small accessibility: keyboard ESC closes modal ---------- */
document.addEventListener('keydown', (e)=> {
  if (e.key === 'Escape') {
    if (modal.style.display === 'flex') closeModal();
  }
});


</script>
 



</HTml>
